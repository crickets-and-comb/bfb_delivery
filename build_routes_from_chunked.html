<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html"><link rel="search" title="Search" href="search.html"><link rel="next" title="Intro to Command Line and Bash" href="intro_to_bash.html"><link rel="prev" title="The Delivery-Planning Workflow" href="workflow.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.12.19 -->
        <title>Build, Optimize, and Distribute Circuit Routes from Chunked Routes Sheet - bfb_delivery 1.1.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">bfb_delivery 1.1.3 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <span class="sidebar-brand-text">bfb_delivery 1.1.3 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow.html">The Delivery-Planning Workflow</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Build, Optimize, and Distribute Circuit Routes from Chunked Routes Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro_to_bash.html">Intro to Command Line and Bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="CLI.html">CLI</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="modules.html">bfb_delivery</a><input aria-label="Toggle navigation of bfb_delivery" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="bfb_delivery.html">bfb_delivery package</a><input aria-label="Toggle navigation of bfb_delivery package" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="bfb_delivery.api.html">bfb_delivery.api package</a></li>
<li class="toctree-l3"><a class="reference internal" href="bfb_delivery.cli.html">bfb_delivery.cli package</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="bfb_delivery.lib.html">bfb_delivery.lib package</a><input aria-label="Toggle navigation of bfb_delivery.lib package" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="bfb_delivery.lib.dispatch.html">bfb_delivery.lib.dispatch package</a></li>
<li class="toctree-l4"><a class="reference internal" href="bfb_delivery.lib.formatting.html">bfb_delivery.lib.formatting package</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="bfb_delivery.lib.schema.html">bfb_delivery.lib.schema package</a><input aria-label="Toggle navigation of bfb_delivery.lib.schema package" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="bfb_delivery.lib.schema.checks.html">bfb_delivery.lib.schema.checks package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developer Resources</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/build_routes_from_chunked.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="build-optimize-and-distribute-circuit-routes-from-chunked-routes-sheet">
<h1>Build, Optimize, and Distribute Circuit Routes from Chunked Routes Sheet<a class="headerlink" href="#build-optimize-and-distribute-circuit-routes-from-chunked-routes-sheet" title="Link to this heading">¶</a></h1>
<p>Once you have a large single-route sheet labeled by driver, representing individual driver routes, you need to upload them to Circuit, optimized them, distribute them to driver apps, and produce driver manifests ready to print, with headers, aggregate data, and color-coded box types. You can do this all at once with the <code class="code docutils literal notranslate"><span class="pre">build_routes_from_chunked</span></code> tool.</p>
<p>This tool replaces the manual tasks of:</p>
<ul class="simple">
<li><p>Splitting the single route grouped by driver into individual Excel worksheets for each driver, grouped into a handful of workbooks for each staff member to upload to Circuit.</p></li>
<li><p>Uploading to Circuit, mapping fields and routes to drivers, optimizing routes, and distributing them to driver apps.</p></li>
<li><p>Downloading the optimized routes, copying each route into a single workbook, running an Excel macro, and finishing up with some manual steps.</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Before using this tool, you need to log in to Circuit and activate the drivers you want to assign routes to.</p>
</div>
<p>Python API documentation at <a class="reference internal" href="bfb_delivery.api.html#bfb_delivery.api.public.build_routes_from_chunked" title="bfb_delivery.api.public.build_routes_from_chunked"><code class="xref py py-func docutils literal notranslate"><span class="pre">bfb_delivery.api.public.build_routes_from_chunked()</span></code></a>.</p>
<p>CLI documentation at <a class="reference internal" href="CLI.html"><span class="doc">CLI</span></a>.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>You call <code class="code docutils literal notranslate"><span class="pre">build_routes_from_chunked</span></code> with the <code class="code docutils literal notranslate"><span class="pre">input_path</span></code> of the chunked spreadsheet, along with any other optional arguments. It will then prompt you to confirm driver assignments to each route. The tool then runs for up to a minute per route and finally prints the filepath to the final manifest.</p>
<p>In Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bfb_delivery</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_routes_from_chunked</span>

<span class="n">build_routes_from_chunked</span><span class="p">(</span><span class="n">input_path</span><span class="o">=</span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>With CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_routes_from_chunked<span class="w"> </span>--input_path<span class="w"> </span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span>
</pre></div>
</div>
<p>The function will return the filepath to the final manifest. If you’re using the CLI, the filepath will print to the console.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This takes up to a minute per route to run as it uploads the routes to Circuit, optimizes them, and downloads the optimized routes. So, for a typical number of routes, it will take about 30 minutes.</p>
</div>
<section id="examining-output">
<h3>Examining output<a class="headerlink" href="#examining-output" title="Link to this heading">¶</a></h3>
<p>Below is an example with three routes (usually about 40-50 routes). The tool will prompt you to assign drivers to each route, e.g. “Enter the number of the driver for ‘02.14 Eric’(ctl+c to start over):”. You use the driver numbers printed to the console to assign drivers to each route, 48 in this example (see input below). The tool will then run for up to a minute per route and finish successfully by printing the filepath to the final manifest.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice how the driver status is printed with the driver. The tool will not allow you to assign an inactive driver to a route, re-prompting you if you do enter an inactive driver. If you need to assign an inactive driver, you will need to activate them in Circuit first.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(bfb_delivery_py3.12) MacBook-Pro:bfb_delivery me$ build_routes_from_chunked --input_path .test_data/scratch/test_master_chunked_sample.xlsx --output_dir .test_data/scratch/
2025-02-12 17:49:38,585 - INFO - Writing split chunked workbooks to /Users/me/repos/bfb_delivery/.test_data/scratch/split_chunked
2025-02-12 17:49:38,620 - INFO - Getting all drivers from Circuit ...
2025-02-12 17:49:39,568 - INFO - Finished getting drivers.
1. Active: Hank Hill hank@propane.com
... (more drivers) ...
84. Active: Nosferatu pinebox@bfb.com

Using the driver numbers above, assign drivers to each route:

Route 02.14 Eric:
Best guesses:
48. Active: Eric Cartman emoney@southpark.com


Enter the number of the driver for &#39;02.14 Eric&#39;(ctl+c to start over):48

Assigned 02.14 Eric to Eric Cartman.

Route 02.14 Hank:
Best guesses:
1. Active: Hank Hill hank@propane.com
23. Inactive: Hankie Who hankie@realtalk.com


Enter the number of the driver for &#39;02.14 Hank&#39;(ctl+c to start over):1

Assigned 02.14 Hank to Hank Hill.

Route 02.14 Nos:
Best guesses:
84. Active: Nosferatu pinebox@bfb.com


Enter the number of the driver for &#39;02.14 Nos&#39;(ctl+c to start over):84

Assigned 02.14 Nos to Nosferatu.
02.14 Eric: Eric Cartman, emoney@southpark.com
02.14 Hank: Hank Hill, hank@propane.com
02.14 Nos: Nosferatu pinebox@bfb.com
Confirm the drivers above? (y/n): y
2025-02-12 17:50:16,179 - INFO - Initializing plans ...
2025-02-12 17:50:18,067 - INFO - Finished initializing plans. Initialized 3 plans.
2025-02-12 17:50:18,126 - INFO - Uploading stops. Allow 6+ seconds per plan ...
2025-02-12 17:50:44,995 - INFO - Finished uploading stops. Uploaded 50 stops for 3 plans.
2025-02-12 17:50:45,023 - INFO - Initializing route optimizations. Allow 20+ seconds per plan ...
2025-02-12 17:51:49,759 - INFO - Finished initializing route optimizations for 3 plans.
2025-02-12 17:51:49,782 - INFO - Confirming optimizations have finished ...
2025-02-12 17:51:50,980 - INFO - Finished optimizing routes. Optimized 3 routes.
2025-02-12 17:51:51,019 - INFO - Distributing routes ...
2025-02-12 17:51:53,200 - INFO - Finished distributing routes for 3 plans.
2025-02-12 17:51:53,222 - INFO -
    route_title  initialized  writable  stops_uploaded optimized  distributed
0  02.14 Eric             True      True            True      True         True
1  02.14 Hank             True      True            True      True         True
2  02.14 Nos              True      True            True      True         True

Plans attempted: 3
Plans initialized: 3
Plans with stops: 3
Plans optimized: 3
Plans distributed: 3
2025-02-12 17:51:53,231 - INFO - Getting route plans from Circuit ...
2025-02-12 17:51:53,692 - INFO - Finished getting route plans.
2025-02-12 17:51:53,711 - INFO - Getting stops from Circuit ...
2025-02-12 17:51:57,597 - INFO - Finished getting stops.
2025-02-12 17:51:57,629 - WARNING - Missing neighborhood for 50 stops. Imputing best guesses from Circuit-supplied address.
2025-02-12 17:51:57,655 - WARNING - Output directory exists /Users/me/repos/bfb_delivery/.test_data/scratch/routes_2025-02-14. Overwriting.
2025-02-12 17:51:57,655 - INFO - Writing route CSVs to /Users/me/repos/bfb_delivery/.test_data/scratch/routes_2025-02-14
2025-02-12 17:51:57,676 - INFO - Writing combined routes to /Users/me/repos/bfb_delivery/.test_data/scratch/combined_routes_20250212.xlsx
2025-02-12 17:51:57,711 - INFO - Writing formatted routes to /Users/me/repos/bfb_delivery/.test_data/scratch/final_manifests_20250212.xlsx
2025-02-12 17:51:57,715 - INFO - Formatted workbook saved to:
/Users/me/repos/bfb_delivery/.test_data/scratch/final_manifests_20250212.xlsx
(bfb_delivery_py3.12) MacBook-Pro:bfb_delivery me$
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Pay attention to the output, especially in the middle once optimization/distribution is complete. There’s a summary of the number of plans attempted, initialized, with stops, optimized, and distributed. Just above that is a table of the routes and their statuses, <code class="code docutils literal notranslate"><span class="pre">True</span></code> indicating success for a route at a given step, <code class="code docutils literal notranslate"><span class="pre">False</span></code> indicating failure. You can also find the table as a CSV file in a subdirectory of the output directory, <code class="code docutils literal notranslate"><span class="pre">{output_dir}/plans/plans.csv</span></code>. If any of the routes are not successul at a step, the tool will warn you and skip them on all following steps. You will want to investigate why and run that route the rest of the way from the last successful step, manually or with the underlying tools (see <a class="reference internal" href="#tools-wrapped-note"><span class="std std-ref">Note on tools this tool wraps</span></a> below).</p>
</div>
<p>Note that the filepaths to some intermediate files will print to the console as well, before finally printing the filepath to the final manifest workbook. In addition to the final manifest, there will be:</p>
<ul class="simple">
<li><p>An Excel workbook of the pre-optmized routes split into separate spreadsheets that you could upload manually. In the example: <code class="docutils literal notranslate"><span class="pre">2025-02-12</span> <span class="pre">17:49:38,585</span> <span class="pre">-</span> <span class="pre">INFO</span> <span class="pre">-</span> <span class="pre">Writing</span> <span class="pre">split</span> <span class="pre">chunked</span> <span class="pre">workbooks</span> <span class="pre">to</span> <span class="pre">/Users/me/repos/bfb_delivery/.test_data/scratch/split_chunked</span></code></p></li>
<li><p>Optmized route CSVs downloaded from Circuit that you could combine into a single Excel workbook. In the example: <code class="docutils literal notranslate"><span class="pre">2025-02-12</span> <span class="pre">17:51:57,655</span> <span class="pre">-</span> <span class="pre">INFO</span> <span class="pre">-</span> <span class="pre">Writing</span> <span class="pre">route</span> <span class="pre">CSVs</span> <span class="pre">to</span> <span class="pre">/Users/me/repos/bfb_delivery/.test_data/scratch/routes_2025-02-14</span></code></p></li>
<li><p>An unformatted Excel workbook of all the routes that you could run the old macro on to produce the final manifests. In the example: <code class="docutils literal notranslate"><span class="pre">2025-02-12</span> <span class="pre">17:51:57,676</span> <span class="pre">-</span> <span class="pre">INFO</span> <span class="pre">-</span> <span class="pre">Writing</span> <span class="pre">combined</span> <span class="pre">routes</span> <span class="pre">to</span> <span class="pre">/Users/me/repos/bfb_delivery/.test_data/scratch/combined_routes_20250212.xlsx</span></code></p></li>
</ul>
<p>This can be helpful if you need to revert to the old method for one of the steps for some reason.</p>
</section>
<section id="reviewing-final-manifests">
<h3>Reviewing final manifests<a class="headerlink" href="#reviewing-final-manifests" title="Link to this heading">¶</a></h3>
<p>You should review the manifests before printing them, as you may want to make some final touchups, like adjusting row heights or column widths, or adding notes. These final touchups are slated to be added to the tool in the future.</p>
</section>
<section id="optional-arguments">
<h3>Optional arguments<a class="headerlink" href="#optional-arguments" title="Link to this heading">¶</a></h3>
<p>You can use optional arguments to specify a few things about the manifest workbook. Use <cite>–help</cite> to see all the optional arguments in the CLI.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_routes_from_chunked<span class="w"> </span>--help
</pre></div>
</div>
<section id="output-directory">
<h4>Output directory<a class="headerlink" href="#output-directory" title="Link to this heading">¶</a></h4>
<p>Use the optional argument <code class="code docutils literal notranslate"><span class="pre">output_dir</span></code> to specify the directory to save the workbook file in. The default if not passed is a new directory in the present working directory, named “deliveries_{date}”.</p>
<p>In Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">build_routes_from_chunked</span><span class="p">(</span>
    <span class="n">input_path</span><span class="o">=</span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;path/to/output_dir/&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>With CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_routes_from_chunked<span class="w"> </span>--input_path<span class="w"> </span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="w"> </span>--output_dir<span class="w"> </span><span class="s2">&quot;path/to/output_dir/&quot;</span>
</pre></div>
</div>
</section>
<section id="start-date">
<h4>Start date<a class="headerlink" href="#start-date" title="Link to this heading">¶</a></h4>
<p>Use the optional argument <code class="code docutils literal notranslate"><span class="pre">start_date</span></code> to specify the beginning of the date range to search Circuit for routes. The default if not passed in is the soonest Friday.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bfb_delivery</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_routes_from_chunked</span>

<span class="n">build_routes_from_chunked</span><span class="p">(</span>
    <span class="n">input_path</span><span class="o">=</span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="s2">&quot;1947-10-14&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>With CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_routes_from_chunked<span class="w"> </span>--input_path<span class="w"> </span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="w"> </span>--start_date<span class="w"> </span><span class="m">1957</span>-10-04
</pre></div>
</div>
</section>
<section id="skip-distribution">
<h4>Skip distribution<a class="headerlink" href="#skip-distribution" title="Link to this heading">¶</a></h4>
<p>By default, the tool will distribute the routes to the driver apps. Use the optional argument <code class="code docutils literal notranslate"><span class="pre">no_distribute</span></code> to skip this.</p>
<p>In Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">build_routes_from_chunked</span><span class="p">(</span>
    <span class="n">input_path</span><span class="o">=</span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="p">,</span>
    <span class="n">no_distribute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>With CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_routes_from_chunked<span class="w"> </span>--input_path<span class="w"> </span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="w"> </span>--no_distribute
</pre></div>
</div>
</section>
<section id="verbose-output">
<h4>Verbose output<a class="headerlink" href="#verbose-output" title="Link to this heading">¶</a></h4>
<p>Use the optional argument <code class="code docutils literal notranslate"><span class="pre">verbose</span></code> to print more information to the console. This can be useful for debugging, but it is pretty noisy.</p>
<p>In Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">build_routes_from_chunked</span><span class="p">(</span>
    <span class="n">input_path</span><span class="o">=</span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>With CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_routes_from_chunked<span class="w"> </span>--input_path<span class="w"> </span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="w"> </span>--verbose
</pre></div>
</div>
</section>
<section id="supplying-extra-notes">
<h4>Supplying extra notes<a class="headerlink" href="#supplying-extra-notes" title="Link to this heading">¶</a></h4>
<p>Use the optional argument <code class="code docutils literal notranslate"><span class="pre">extra_notes_file</span></code> to specify a CSV file with extra notes to include in the manifest. The CSV file should have two columns: <code class="code docutils literal notranslate"><span class="pre">tag</span></code> and <code class="code docutils literal notranslate"><span class="pre">note</span></code>. The tag is the text (usually asterisked) that appears in the standard notes field for a delivery. The note is then added to the bottom of the manifest with the tag. For example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>tag,note
Cedarwood Apartments special instructions *,Please call the recipient when you arrive.
</pre></div>
</div>
<p>This file will put the note “Please call the recipient when you arrive.” at the bottom of the manifest (once) if any stops have a note that contains the text “Cedarwood Apartments special instructions *”.</p>
<p>If you don’t provide <code class="code docutils literal notranslate"><span class="pre">extra_notes_file</span></code> provide, the tool will use the constant notes in the codebase: <a class="reference internal" href="bfb_delivery.lib.html#bfb_delivery.lib.constants.ExtraNotes" title="bfb_delivery.lib.constants.ExtraNotes"><code class="xref py py-data docutils literal notranslate"><span class="pre">bfb_delivery.lib.constants.ExtraNotes</span></code></a> (currently empty).</p>
<p>In Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">build_routes_from_chunked</span><span class="p">(</span>
    <span class="n">input_path</span><span class="o">=</span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="p">,</span>
    <span class="n">extra_notes_file</span><span class="o">=</span><span class="s2">&quot;path/to/extra_notes.csv&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>With CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_routes_from_chunked<span class="w"> </span>--input_path<span class="w"> </span><span class="s2">&quot;path/to/master_chunked_sheet.xlsx&quot;</span><span class="w"> </span>--extra_notes_file<span class="w"> </span>path/to/extra_notes.csv
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Extra notes are placed in merged cells with automatic row height calculation. The height calculation is approximate and may not be perfect for all text lengths and formatting. Manual review of the cell heights is recommended to ensure notes are fully visible.</p>
</div>
</section>
</section>
</section>
<section id="note-on-tools-this-tool-wraps">
<span id="tools-wrapped-note"></span><h2>Note on tools this tool wraps<a class="headerlink" href="#note-on-tools-this-tool-wraps" title="Link to this heading">¶</a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">build_routes_from_chunked</span></code> wraps other tools that run each segment of the pipeline. First it runs <code class="code docutils literal notranslate"><span class="pre">split_chunked_route</span></code> to split the master chunked sheet into spreadsheets for each route in a single workbook before uploading. It then runs <code class="code docutils literal notranslate"><span class="pre">create_manifests_from_circuit</span></code>, so you don’t have to download and move files around and format them. <code class="code docutils literal notranslate"><span class="pre">create_manifests_from_circuit</span></code> actually wraps <code class="code docutils literal notranslate"><span class="pre">create_manifests</span></code>, which in turn wraps two other tools, <code class="code docutils literal notranslate"><span class="pre">combine_route_tables</span></code> and <code class="code docutils literal notranslate"><span class="pre">format_combined_routes</span></code> into one tool. You can still use any of those tools if you wish, but you can instead just use <code class="code docutils literal notranslate"><span class="pre">build_routes_from_chunked</span></code>. Calling these intermediate tools from <code class="code docutils literal notranslate"><span class="pre">build_routes_from_chunked</span></code> wasn’t necessary, but it was convenient to develop that way and has the added benefit of producing intermediate files at each step that you can use if you need to revert to the old method for some of the steps for some reason (say there was an error in one of the route optimizations and you want to retry it without running all of them again).</p>
<figure class="align-default" id="id1">
<pre  class="mermaid">
        graph TD;
    A[**build_routes_from_chunked**] --&gt; B[**split_chunked_route**]
    B --&gt; B1[Splits master chunked sheet into individual driver route sheets.]
    A --&gt; C[Uploads routes to Circuit, optimizes, and distributes to drivers.]
    A --&gt; D[**create_manifests_from_circuit**]
    D --&gt; E[Gets routes from Circuit.]
    D --&gt; F[**create_manifests**]
    F --&gt; G[**combine_route_tables**]
    F --&gt; H[**format_combined_routes**]
    G --&gt; G1[Combines downloaded routes CSVs into a single workbook.]
    H --&gt; H1[Formats the combined routes into printable manifests.]
    </pre><figcaption>
<p><span class="caption-text">Subtools wrapped and alternatively available for use</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>For instance, say you’ve found a bug when using <code class="code docutils literal notranslate"><span class="pre">build_routes_from_chunked</span></code> where the routes uploaded and optimized but for some reason didn’t produce the final printable manifest. You could try downloading the routes manually then running <code class="code docutils literal notranslate"><span class="pre">create_manifests</span></code>, or downloading manually then running <code class="code docutils literal notranslate"><span class="pre">combine_route_tables</span></code> and passing its output to <code class="code docutils literal notranslate"><span class="pre">format_combined_routes</span></code>. For whichever of those steps fails, you can revert to using your old method, but you can still ostensibly use a tool for the other piece that didn’t fail. For example, say <code class="code docutils literal notranslate"><span class="pre">combine_route_tables</span></code> ran fine, but <code class="code docutils literal notranslate"><span class="pre">format_combined_routes</span></code> threw an error, so you reverted to using the old Excel macro and manually formatting. See <a class="reference internal" href="split_chunked_route.html"><span class="doc">Split Chunked Route Sheet into Multiple Files</span></a>, <a class="reference internal" href="create_manifests_from_circuit.html"><span class="doc">Create Printable Manifests from Optimized Routes from Circuit</span></a>, <a class="reference internal" href="create_manifests.html"><span class="doc">Create Printable Manifests from Downloaded Optimized Routes</span></a>, <a class="reference internal" href="combine_route_tables.html"><span class="doc">Combine Driver Route Tables into a Single Workbook</span></a> and <a class="reference internal" href="format_combined_routes.html"><span class="doc">Format Manifests</span></a>.</p>
<p>Most likely you’ll find that the tool works fine unless the underlying data schemata have changed, but it’s good to know you have options to explore instead of doing it all manually again.</p>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="workflow.html"><span class="doc">The Delivery-Planning Workflow</span></a></p>
<p><a class="reference internal" href="split_chunked_route.html"><span class="doc">Split Chunked Route Sheet into Multiple Files</span></a></p>
<p><a class="reference internal" href="create_manifests_from_circuit.html"><span class="doc">Create Printable Manifests from Optimized Routes from Circuit</span></a></p>
<p><a class="reference internal" href="create_manifests.html"><span class="doc">Create Printable Manifests from Downloaded Optimized Routes</span></a></p>
<p><a class="reference internal" href="combine_route_tables.html"><span class="doc">Combine Driver Route Tables into a Single Workbook</span></a></p>
<p><a class="reference internal" href="format_combined_routes.html"><span class="doc">Format Manifests</span></a></p>
<p><a class="reference internal" href="CLI.html"><span class="doc">CLI</span></a></p>
<p><a class="reference internal" href="bfb_delivery.api.html"><span class="doc">bfb_delivery.api package</span></a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="intro_to_bash.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Intro to Command Line and Bash</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="workflow.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">The Delivery-Planning Workflow</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Kaleb Coberly
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Build, Optimize, and Distribute Circuit Routes from Chunked Routes Sheet</a><ul>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#examining-output">Examining output</a></li>
<li><a class="reference internal" href="#reviewing-final-manifests">Reviewing final manifests</a></li>
<li><a class="reference internal" href="#optional-arguments">Optional arguments</a><ul>
<li><a class="reference internal" href="#output-directory">Output directory</a></li>
<li><a class="reference internal" href="#start-date">Start date</a></li>
<li><a class="reference internal" href="#skip-distribution">Skip distribution</a></li>
<li><a class="reference internal" href="#verbose-output">Verbose output</a></li>
<li><a class="reference internal" href="#supplying-extra-notes">Supplying extra notes</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#note-on-tools-this-tool-wraps">Note on tools this tool wraps</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=cb7bf70b"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=46bd48cc"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script>
    </body>
</html>